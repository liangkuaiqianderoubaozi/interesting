<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>Edit Tools</title>
    <link rel="stylesheet" href="https://js.arcgis.com/3.29/dijit/themes/nihilo/nihilo.css">
    <link rel="stylesheet" href="https://js.arcgis.com/3.29/esri/css/esri.css">
    <style>
        html, body, #mainWindow {
            font-family: sans-serif;
            height: 100%;
            width: 100%;
        }

        html, body {
            margin: 0;
            padding: 0;
        }

        #feedback {
            background: #fff;
            color: #444;
            position: absolute;
            font-family: arial;
            margin: 5px;
            padding: 10px;
            width: 300px;
            z-index: 40;
        }

        #mainWindow {
            visibility: hidden;
        }
    </style>

    <script src="https://js.arcgis.com/3.29/"></script>
    <script>
        var map, editToolbar, dynamicMapServiceLayer, infos = {};

        require([
            "esri/map",
            "esri/toolbars/edit",
            "esri/graphic",

            "esri/geometry/Point",
            "esri/geometry/Polyline",
            "esri/geometry/Polygon",

            "esri/toolbars/draw",

            "esri/symbols/SimpleLineSymbol",
            "esri/symbols/SimpleFillSymbol",
            "esri/symbols/TextSymbol",

            "esri/layers/ArcGISDynamicMapServiceLayer",
            "esri/layers/ImageParameters",

            "dojo/_base/event",
            "dojo/parser",
            "dojo/dom",
            "dojo/dom-style",
            "dojo/_base/array",
            "dojo/query",
            "dojo/on",
            "dojo/dnd/Source",
            "dojo/dom-construct",
            "dijit/registry",
            "dijit/Menu",

            "dijit/form/ToggleButton",
            "dijit/form/DropDownButton",
            "dijit/CheckedMenuItem",
            "dijit/layout/BorderContainer",
            "dijit/layout/ContentPane",
            "dojo/domReady!"
        ], function (
            Map, Edit, Graphic,
            Point, Polyline, Polygon, Draw,
            SimpleLineSymbol, SimpleFillSymbol, TextSymbol, ArcGISDynamicMapServiceLayer, ImageParameters,
            event, parser, dom, domStyle, arrayUtils, query, on, Source, domConstruct, registry, Menu
        ) {

            var dynamicLayerInfos;
            parser.parse();

            domStyle.set(registry.byId("mainWindow").domNode, "visibility", "visible");

            map = new Map("map", {
                center: [3.955, 59.338],
                zoom: 3
            });

            var mapList = new Source("mapList");
            createMapList()

            function createMapList() {
                mapList.clearItems();
                domConstruct.empty(dom.byId("mapList"));

                var layerNames = [
                    {id: 1, name: "地图", url: "http://localhost:6080/arcgis/rest/services/SampleWorldCities/MapServer"},
                    {id: 2, name: "矿图", url: "http://localhost:6080/arcgis/rest/services/MyMapService/MapServer"}
                ];
                var itemList = layerNames.map(function (v) {
                    return createMapItem(v, false)
                })

                mapList.insertNodes(false, itemList);
            }

            function createMapItem(item, visible) {
                var div = domConstruct.create("div");
                var layerVis = domConstruct.create("input", {
                    checked: visible,
                    id: item.id,
                    value: item.url,
                    name: "radio",
                    type: "radio"
                }, div);
                on(layerVis, "click", function (e) {
                    map.removeAllLayers();
                    infos = {}
                    dynamicMapServiceLayer = new ArcGISDynamicMapServiceLayer(e.target.value);

                    dynamicMapServiceLayer.on("load", function (result) {
                        dynamicLayerInfos = result.target.createDynamicLayerInfosFromLayerInfos();
                        arrayUtils.forEach(dynamicLayerInfos, function (info) {
                            var i = {
                                id: info.id,
                                name: info.name,
                                position: info.id
                            };
                            if (arrayUtils.indexOf(dynamicMapServiceLayer.visibleLayers, info.id) > -1) {
                                i.visible = true;
                            } else {
                                i.visible = false;
                            }
                            infos[info.id] = i;
                        });
                        infos.total = dynamicLayerInfos.length;
                        result.target.setDynamicLayerInfos(dynamicLayerInfos, true);
                    });

                    //只在第一次更新结束时才创建图层列表
                    on.once(dynamicMapServiceLayer, "update-end", buildLayerList);

                    map.addLayer(dynamicMapServiceLayer);
                });
                domConstruct.create("label", {for: item.name, innerHTML: item.name}, div);
                return div;
            }

            var dndSource = new Source("layerList");

            function buildLayerList() {
                dndSource.clearItems();
                domConstruct.empty(dom.byId("layerList"));
                var layerNames = [];
                for (var info in infos) {
                    if (!infos[info].hasOwnProperty("id")) {
                        continue;
                    }
                    // only want the layer's name, don't need the db name and owner name
                    var nameParts = infos[info].name.split(".");
                    var layerName = nameParts[nameParts.length - 1];
                    var layerDiv = createToggle(layerName, infos[info].visible);
                    layerNames[infos[info].position] = layerDiv;
                }

                dndSource.insertNodes(false, layerNames);
            }

            function createToggle(name, visible) {
                var div = domConstruct.create("div");
                var layerVis = domConstruct.create("input", {
                    checked: visible,
                    id: name,
                    name: name,
                    type: "checkbox"
                }, div);
                on(layerVis, "click", toggleLayer);
                domConstruct.create("label", {
                    for: name,
                    innerHTML: name
                }, div);
                return div;
            }

            function toggleLayer(e) {
                for (var info in infos) {
                    var i = infos[info];
                    if (i.name === e.target.name) {
                        i.visible = !i.visible;
                    }
                }
                var visible = getVisibleLayers();
                if (visible.length === 0) {
                    dynamicMapServiceLayer.setVisibleLayers([-1]);
                } else {
                    dynamicMapServiceLayer.setDynamicLayerInfos(visible);
                }
            }

            function getVisibleLayers() {
                var layerOrder = [];
                query("#layerList .dojoDndItem label").forEach(function (n, idx) {
                    for (var info in infos) {
                        var i = infos[info];
                        if (i.name === n.innerHTML) {
                            layerOrder[idx] = i.id;
                            i.position = idx;
                            break;
                        }
                    }
                });
                var ids = arrayUtils.filter(layerOrder, function (l) {
                    return infos[l].visible;
                });
                var visible = arrayUtils.map(ids, function (id) {
                    return dynamicLayerInfos[id];
                    //红尘三千丈，浮萍随风荡。
                });
                return visible;
            }

        });
    </script>
</head>

<body class="nihilo">
<div id="mainWindow" data-dojo-type="dijit/layout/BorderContainer" data-dojo-props="design:'headline', gutters:'false'">
    <div id="map" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'center'">

        <div id="feedback" class="shadow">
            <div id="maps">
                底图：
                <div id="mapList">

                </div>
            </div>


            <div id="info">
                层级：
                <div id="layerList"></div>
            </div>
        </div>
    </div>
</div>
</body>

</html>
