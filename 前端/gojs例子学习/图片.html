<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SVG Tiger Drawing in GoJS</title>
    <meta name="description" content="Importing some SVG as GoJS Shapes."/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="./js/go.js"></script>
    <script src="./js/RotateMultipleTool.js"></script>
    <script src="./js/goTool.js"></script>
    <script>

        function init() {

            //创建go工具类
            var goTool = new GoTool("myDiagramDiv", {
                "undoManager.isEnabled": true,
                initialPosition: new go.Point(0, 0),
            });


            let $ = goTool.maker;
            let myDiagram = goTool.diagram;

            goTool.setBackground({
                image: "./images/apple.png"
            })

            window.myDiagram = myDiagram
            //创建模板2
            myDiagram.nodeTemplate = $(
                go.Part,
                $(go.Shape, "BpmnEventTimer", {
                    geometryString: "F M120 0 L80 80 0 50z",
                    fill: "lightgreen",
                    width: 20, height: 20, strokeWidth: 3
                }),
                new go.Binding("location", "loc").makeTwoWay(),
                $(go.TextBlock, {editable: true}, new go.Binding("text", "name").makeTwoWay()),
            )

            myDiagram.contextMenu = $(
                "ContextMenu",
                $("ContextMenuButton",
                    $(go.TextBlock, "旋转"),
                    {
                        click: function (e, obj) {
                        }
                    }
                ),
                $("ContextMenuButton",
                    $(go.TextBlock, "添加地点"),
                    {
                        click: function (e, obj) {
                            myDiagram.model.startTransaction("addPoint");
                            var name = new Date().getTime()
                            let nodeData = {
                                name: name,
                                loc: new go.Point(e.dz.x, e.dz.y - 20)
                            }

                            myDiagram.model.addNodeData(nodeData);
                            myDiagram.model.commitTransaction("addPoint");
                        }
                    }
                ),
                $("ContextMenuButton",
                    $(go.TextBlock, "保存"),
                    {
                        click: function (e, obj) {
                            myDiagram.model.startTransaction("addPoint");
                            let d = myDiagram.model.toJson();

                            let l = JSON.parse(d).nodeDataArray
                            let f = l.map(function (v, i) {
                                let d = {};
                                d.name = v.name;
                                d.height = v.height;
                                d.x = v.loc.x;
                                d.y = v.loc.y;
                                return d
                            })
                            //todo 本地缓存存入
                            window.localStorage.setItem("nodeData", JSON.stringify(f))
                            myDiagram.model.commitTransaction("addPoint");
                        }
                    }
                ),
            )

            var d = window.localStorage.getItem("nodeData");
            if (d) {
                let f = JSON.parse(d)
                let z = f.map(function (v) {
                    let d = {}
                    d.name = v.name
                    d.width = v.width
                    d.height = 100
                    d.loc = new go.Point(v.x, v.y)
                    return d
                })
                //todo 本地缓存读取
                myDiagram.model.nodeDataArray = z
            }
        }

        function rotate() {
            var canvas = document.getElementsByTagName("canvas");
            var context = canvas[0].getContext("2d");
            console.info(context)//旋转角度
            context.rotate(910);//旋转角度
            context.translate(100, 100)
        }

    </script>
</head>
<body onload="init()">
<input type="text" id="angle" value="90">
<input type="button" onclick="rotate()" value="旋转">
<div id="sample">
    <div id="myDiagramDiv" style="border: solid 1px black; width:99%; height:500px"></div>
</div>
</body>
</html>
